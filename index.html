<!doctype html>
<html lang="DE-de">
<head>
    <meta name="Author" content="Dieter Leßmann" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Wanderung in der Egge vom Parklatz der Adlerwarte über die Falkenbur zu den Externsteinen" />
    <!-- Leaflet style. REQUIRED! -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" />
    <title>Eggewanderung</title>
    <link rel="stylesheet" href="css/karte.css">
    <link rel="stylesheet" href="css/popup-custom.css">
    <style>
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0; }
        .map { height: 100% }
    </style>
    <style>
        #nordpfeil-container {
            position: absolute;
            top: 60px;
            left: 40px;
            z-index: 1000;
        }

        #nordpfeil {
            width: 92px;
            height: 92px;
            background-image: url('icons/Nordpfeil.png');
            background-size: cover;
        }
    </style>
    <style>
        .legend {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .legend-item {
            display: flex;
            align-items: center;
        }

        .legend-text {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="header"><p>Eggewanderung</p></div>
    <div id="footer"><p>(c) by Dieter Leßmann </p></div>
    <div id="map" class="map"></div>
    <div id="bibliokarte" style="width: 950px; height: 850px"></div>
    <div id="elevationChart"></div>

    <div id="nordpfeil-container">
        <div id="nordpfeil"></div>
    </div>

    <div class="legend">
        <div class="legend-item">Legende</div>
        <span class="legend-text">Legende</span>
    </div>

    <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="js/leaflet-providers.js"></script>

    <script src="js/main.js" type="text/javascript"></script>
    <script src="js/bibliotheken_egge.js" type="text/javascript"></script>
    <script src="js/track_egge_2.js" type="text/javascript"></script>

    <script>
        var map;
        var currentMarker = null;
        var trackKoordinaten = [];
    
        function initializeMap() {
            if (map) {
                map.remove(); // Entferne die alte Karte, wenn sie existiert
            }
    
            map = L.map('map').setView([51.9, 8.7], 13);
    
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
    
            var group = L.featureGroup().addTo(map);
            var bib = L.geoJson(bibliotheken, {
                pointToLayer: function (feature, latlng) {
                    var art = feature.properties.Art;
                    var marker;
                    switch (art) {
                        case "Öffentlicher Tierpark":
                            marker = L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'icons/logo-twitter.svg',
                                    iconSize: [32, 32]
                                })
                            });
                            break;
                        case "Öffentlicher_Parkplatz":
                            marker = L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'icons/car.svg',
                                    iconSize: [32, 32]
                                })
                            });
                            break;
                        case "Öffentliche Burgruine":
                            marker = L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'icons/golf.svg',
                                    iconSize: [32, 32]
                                })
                            });
                            break;
                        case "Öffentliches Denkmal":
                            marker = L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'icons/flag.svg',
                                    iconSize: [32, 32]
                                })
                            });
                            break;
                        case "Hotel":
                            marker = L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'icons/cafe.svg',
                                    iconSize: [32, 32]
                                })
                            });
                            break;
                        case "Hütte":
                            marker = L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'icons/location.svg',
                                    iconSize: [32, 32]
                                })
                            });
                            break;
                        case "Restaurant":
                            marker = L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'icons/restaurant.svg',
                                    iconSize: [32, 32]
                                })
                            });
                            break;
                        default:
                            marker = L.circleMarker(latlng, {
                                radius: 8,
                                fillColor: "#0066ff",
                                color: "##0066ff",
                                weight: 0.8,
                                opacity: 1,
                                fillOpacity: 0.6
                            });
                            break;
                    }
                    return marker;
                },
                onEachFeature: function (feature, layer) {
                    var popupContent = "<b>" + feature.properties.Bezeichnung + "</b><br>" +
                        "Adresse: " + feature.properties.Strasse + " " + feature.properties.Hausnr + "<br>" +
                        feature.properties.PLZ + " " + feature.properties.Ort + "<br>";
                    if (feature.properties.Homepage !== "") {
                        popupContent += "Homepage: <a href='" + feature.properties.Homepage + "' target='_blank'>" + feature.properties.Homepage + "</a><br>";
                    }
                    layer.bindPopup(popupContent);
                }
            }).addTo(group);
    
            var track = L.geoJSON(track_egge_2, {
                style: function (feature) {
                    return { color: 'red' };
                },
                onEachFeature: function (feature, layer) {
                    var coordinates = feature.geometry.coordinates;
                    trackKoordinaten.push(...coordinates);
    
                    var popupContent = createTrackPopup(coordinates);
                    layer.bindPopup(popupContent);
    
                    layer.on('mouseover', function () {
                        layer.setStyle({ weight: 8 });
                    });
    
                    layer.on('mouseout', function () {
                        layer.setStyle({ weight: 3 });
                    });
                }
            }).addTo(group);
    
            var bbox = group.getBounds();
            map.fitBounds(bbox);
    
            var scale = L.control.scale().addTo(map);
    
            currentMarker = L.marker([0, 0], { opacity: 0 }).addTo(map);
    
            var legend = L.control({ position: 'bottomright' });
    
            legend.onAdd = function () {
                var div = L.DomUtil.create('div', 'legend');
                var labels = [
                    '<div class="legend-item"><i class="fa fa-map-marker" style="color:#0066ff"></i><span class="legend-text">Legende</span></div>',
                    '<img src="icons/Track-Menue.png" style="width:16px;height:16px;"> Track',
                    '<img src="icons/logo-twitter.svg" style="width:16px;height:16px;"> Adlerwarte',
                    '<img src="icons/car.svg" style="width:16px;height:16px;"> Treffpunkt - Parkplatz Adlerwarte',
                    '<img src="icons/golf.svg" style="width:16px;height:16px;"> Falkenburg',
                    '<img src="icons/flag.svg" style="width:16px;height:16px;"> Externsteine',
                    '<img src="icons/cafe.svg" style="width:16px;height:16px;"> Waldesruh Wanderhotel Externsteine',
                    '<img src="icons/location.svg" style="width:16px;height:16px;"> Rigi Hütte',
                    '<img src="icons/restaurant.svg" style="width:16px;height:16px;"> Landhaus Hirschsprung'
                ];
                div.innerHTML = labels.join('<br>');
                return div;
            };
    
            legend.addTo(map);
        }
    
        function openHeightProfilePopup(coordinates) {
            var heightProfileWindow = window.open('height_profile.html', 'Height Profile', 'width=600,height=400');
            heightProfileWindow.onload = function () {
                if (!heightProfileWindow.loaded) {
                    heightProfileWindow.loaded = true;
    
                    var heights = coordinates.map(coord => coord[2]);
    
                    var ctx = heightProfileWindow.document.getElementById('heightProfile').getContext('2d');
                    var chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: heights.map((h, i) => i),
                            datasets: [{
                                label: 'Height Profile',
                                data: heights,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Height (m)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Point Index'
                                    }
                                }
                            }
                        });
                    }
                }
            };
        }
    
        function createTrackPopup(coordinates) {
            var coordinatesStr = JSON.stringify(coordinates).replace(/"/g, '&quot;'); // Entkomme Anführungszeichen
            var popupContent = '<div>';
            popupContent += '<p>Wir starten vom Parkplatz der Adlerwarte, entgegen dem Uhrzeigersinn, über die Ruine der Falkenburg zu den Externsteinen.</p>';
            popupContent += '<button onclick="openHeightProfilePopup(' + coordinatesStr + ')">Höhenprofil anzeigen</button>';
            popupContent += '</div>';
            return popupContent;
        }
    
        document.addEventListener('DOMContentLoaded', initializeMap);
    </script>

</body>
</html>
